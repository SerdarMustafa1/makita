name: Scheduled run

on:
  schedule:
    # every 8 hours => ~3x/day (adjust cron if you prefer different frequency)
    - cron: '0 */8 * * *'
  workflow_dispatch:

concurrency:
  group: scheduled-run
  cancel-in-progress: false

jobs:
  run-scheduled:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Prepare DB
        run: |
          npm run setup

      - name: Install Playwright browsers
        run: |
          npx playwright install --with-deps

      # Debug steps removed — production run

      - name: Run scheduled script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        shell: bash
        run: |
          set -o pipefail
          npm run run 2>&1 | tee run-output.txt

      - name: Notify on failure (Telegram)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          WORKFLOW: ${{ github.workflow }}
          GIT_SHA: ${{ github.sha }}
          JOB_NAME: ${{ github.job }}
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA=${GIT_SHA:0:7}
          SNIPPET=""
          if [ -f run-output.txt ]; then
            SNIPPET=$(tail -n 20 run-output.txt | tr '\n' ' ' | sed 's/"/\\"/g' | cut -c1-300)
          fi
          MSG="CI FAIL — ${WORKFLOW} — ${REPO}\nJob: ${JOB_NAME}\nCommit: ${SHORT_SHA}\nRun: https://github.com/${REPO}/actions/runs/${RUN_ID}"
          if [ -n "$SNIPPET" ]; then
            MSG="$MSG\nError: ${SNIPPET}"
          fi
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            -d text="$MSG" || true
